// Editions version of proto3 file
edition = "2023";
package io.clbs.openhes.models.messaging;

option go_package = "github.com/cybroslabs/ouro-api-shared/gen/go/messaging";

import "google/protobuf/wrappers.proto";
import "common/fields.proto";
import "common/metadata.proto";

// Defines messages sent from a consumer client to the messaging server in a bidirectional stream.
// Consumers use this to establish a connection, acknowledge processed messages, or reject failed messages.
message MessagingConsumerClient {
    oneof kind {
        MessagingConsumerSetup setup    = 1;  // Setup message to initialize the consumer connection. Must be the first message sent. Subsequent setup messages are rejected.
        google.protobuf.StringValue ack = 2;  // Acknowledgement confirming successful processing of a message. The message is removed from the queue.
        google.protobuf.StringValue nak = 3;  // Negative acknowledgement indicating processing failure. The message is requeued for redelivery.
    }
}

// Defines messages sent from the messaging server to a consumer client in a bidirectional stream.
// The server delivers messages that match the consumer's subscribed subjects.
message MessagingConsumerServer {
    oneof kine {
        MessagingReceiveMessage receive = 1;  // Delivers a message to the consumer for processing. The consumer must ack or nak this message.
    }
}

// Defines messages sent from a publisher client to the messaging server in a client stream.
// Publishers use this to establish a connection and send messages to specific subjects.
message MessagingPublisherClient {
    oneof kind {
        MessagingPublisherSetup setup   = 1;  // Setup message to initialize the publisher connection. Must be the first message sent. Subsequent setup messages are rejected.
        MessagingPublishMessage publish = 2;  // Publishes a message to a subject. All consumers subscribed to this subject will receive it.
    }
}

// Defines a specification for messages to initialize a publisher.
message MessagingPublisherSetup {
    reserved 1, 2;
    common.MetadataFields metadata = 3;  // The metadata fields. The ID and name represent the component ID and name and must match for all publishers and consumers of the same component.
}

// Defines a publish action for sending messages.
message MessagingPublishMessage {
    // The subject of the message. The subject must start with the 'events.custom.' prefix.
    // @example: "events.custom.sapmessage"
    string subject = 1;
    bytes data     = 2;  // The message data.
}

// Defines a specification for messages to initialize a consumer.
message MessagingConsumerSetup {
    reserved 1;
    MessagingComponentConsumerSettings settings = 2;  // The consumer-specific message settings.
    common.MetadataFields metadata              = 3;  // The metadata fields. The ID and name represent the component ID and name and must match for all publishers and consumers of the same component.
}

// Defines a specification for messages delivered from server to a consumer.
message MessagingReceiveMessage {
    // The unique message identifier.
    // @gqltype: UUID
    string message_id = 1;
    // The subjects of the message.
    // @example: "events.public.acquisition.jobdone"
    string subject    = 2;
    bytes data        = 3;  // The message data.
}

// Defines a list o messaging components.
message ListOfMessagingComponent {
    repeated MessagingComponent items = 1;  // The list of messaging components known to the system.
    int32 total_count                 = 2;  // The total number of items in the list.
}

// Defines a specification of the messaging component.
message MessagingComponent {
    MessagingComponentSpec spec     = 1;  // The specification of the messaging component.
    MessagingComponentStatus status = 2;  // The status of the messaging component.
    common.MetadataFields metadata  = 3;  // The metadata fields.
}

// Defines configuration settings for a specific consumer within a messaging component.
// Each consumer represents a logical queue handler that processes messages from subscribed subjects.
message MessagingComponentConsumerSettings {
    // The unique UUID identifier for this consumer instance. Must be unique across all consumers of the same component.
    // @gqltype: UUID
    string consumer_id           = 1;
    // The maximum number of unacknowledged messages this consumer can have. Values >1 enable concurrent processing but may lose order. Value 1 guarantees ordered processing.
    // @example: 1
    // @example: 10
    // @example: 100
    int32 max_in_flight_messages = 2;
    // The message subjects this consumer subscribes to. At least one subject is required. Changes apply to all instances of the component.
    // @example: ["events.public.acquisition.jobdone", "events.public.something.else"]
    // @example: ["events.custom.sapmessage"]
    repeated string subjects     = 3;
}

// Defines the configuration specification for a messaging component.
// Components represent microservices or system modules that publish and/or consume messages.
message MessagingComponentSpec {
    bool enabled                                          = 1;  // When false, the component cannot publish or consume messages. Useful for maintenance or debugging.
    repeated MessagingComponentConsumerSettings consumers = 2;  // The list of consumer configurations for this component. Each consumer handles specific message subjects.
}

// Defines the status of a messaging component.
message MessagingComponentStatus {
    // FIXME: Add status fields as needed
}
